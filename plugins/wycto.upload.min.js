(function($){$.fn.wyctoUpload=function(options){var defaults={"method":0,quality:100,"url":"/default/ajax/uploadfile","allowType":["jpg","jpeg","png","gif","bmp"],"allowSize":0,"success":success,"error":error};$("canvas").remove();var tag=$(this).attr("class")||$(this).attr("id");$(this).after('<input id="wycto-fileupload-'+tag+'" type="file" accept="image/*" multiple="multiple" style="display:none"/><img src="" id="resource-'+tag+'" style="display:none"/><canvas id="canvas'+tag+'" style="display:none"></canvas>');var fileInput=$("#wycto-fileupload-"+tag);$(this).click(function(){fileInput.click()});var resource=$("#resource-"+tag)[0];var config=$.extend(defaults,options);var imgBox=config.imgBox;var width=config.width;var height=config.height;var quality=config.quality;var success=config.success;var error=config.error;fileInput.each(function(i){fileInput.change(function(e){handleFileSelect(fileInput,width,height)})});var handleFileSelect=function(obj,_w,_h){if(typeof FileReader=="undefined"){if(typeof(error)=="function"){error("浏览器版本过低,请升级或者更换浏览器再试")}return false}var files=obj[0].files;var f=files[0];if(!isAllowFile(f.name,config.allowType)){if(typeof(error)=="function"){error("请上传 :"+config.allowType+"格式的文件")}return false}if(!isAllowSize(f.size,config.allowSize)){if(typeof(error)=="function"){if(config.allowSize<1024){size=config.allowSize+"KB"}else{size=config.allowSize/1024+"MB"}error("文件大小不超过"+size)}return false}var reader=new FileReader();reader.readAsDataURL(f);reader.onload=(function(theFile){return function(e){var tmpSrc=e.target.result;var name=getFileName(f.name);var ext=getFileExt(f.name).toLowerCase();if(tmpSrc.lastIndexOf("data:base64")!=-1){tmpSrc=tmpSrc.replace("data:base64","data:image/jpeg;base64")}else{if(tmpSrc.lastIndexOf("data:,")!=-1){tmpSrc=tmpSrc.replace("data:,","data:image/jpeg;base64,")}}if(quality!=100){resource.src=this.result;var re=compress(resource,quality,ext);tmpSrc=re.newImageData}if(config.method){$.post(config.url,{img:tmpSrc,fileext:ext},function(data,status){if(status=="success"){if(typeof(success)=="function"){success(data,name,ext)}}else{if(typeof(error)=="function"){error(tmpSrc)}}})}else{if(typeof(success)=="function"){success(tmpSrc,name,ext)}}}})(f)};var getFileName=function(fileName){if(!fileName){return""}var _index=fileName.lastIndexOf(".");if(_index<1){return""}return fileName.substr(0,_index)};var getFileExt=function(fileName){if(!fileName){return""}var _index=fileName.lastIndexOf(".");if(_index<1){return""}return fileName.substr(_index+1)};var isAllowFile=function(fileName,allowType){var fileExt=getFileExt(fileName).toLowerCase();if(!allowType){allowType=["jpg","jpeg","png","gif","bmp"]}if($.inArray(fileExt,allowType)!=-1){return true}return false};var isAllowSize=function(fileSize,allowSize){if(config.allowSize>0&&fileSize>allowSize*1024){return false}return true};var compress=function(source_img_obj,quality,output_format){var mime_type="image/jpeg";if(output_format!=undefined&&output_format=="png"){mime_type="image/png"}var cvs=$("#canvas"+tag)[0];cvs.width=source_img_obj.width;cvs.height=source_img_obj.height;var ctx=cvs.getContext("2d").drawImage(source_img_obj,0,0);var newImageData=cvs.toDataURL(mime_type,quality/100);var result_image_obj=new Image();result_image_obj.src=newImageData;return data={"result_image_obj":result_image_obj,"newImageData":newImageData}}}})(jQuery);