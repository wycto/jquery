(function($){$.fn.wyctoUpload=function(options){var defaults={"method":0,"imgBox":".imgBox","width":"","height":"","url":"/default/ajax/uploadfile","allowType":["jpg","jpeg","png","gif","bmp"],"allowSize":0,"success":success,"error":error};$(this).after('<input id="wycto-fileupload-input" type="file" accept="image/*" multiple="multiple" style="display:none"/>');var fileInput=$("#wycto-fileupload-input");$(this).click(function(){fileInput.click()});var config=$.extend(defaults,options);var imgBox=config.imgBox;var width=config.width;var height=config.height;var success=config.success;var error=config.error;fileInput.each(function(i){fileInput.change(function(e){handleFileSelect(fileInput,width,height)})});var handleFileSelect=function(obj,_w,_h){if(typeof FileReader=="undefined"){if(typeof(error)=="function"){error("浏览器版本过低,请升级或者更换浏览器再试")}return false}var files=obj[0].files;var f=files[0];if(!isAllowFile(f.name,config.allowType)){if(typeof(error)=="function"){error("请上传 :"+config.allowType+"格式的文件")}return false}if(!isAllowSize(f.size,config.allowSize)){if(typeof(error)=="function"){if(config.allowSize<1024){size=config.allowSize+"KB"}else{size=config.allowSize/1024+"MB"}error("文件大小不超过"+size)}return false}var reader=new FileReader();reader.onload=(function(theFile){return function(e){var tmpSrc=e.target.result;var name=getFileName(f.name);var ext=getFileExt(f.name).toLowerCase();if(config.method){if(tmpSrc.lastIndexOf("data:base64")!=-1){tmpSrc=tmpSrc.replace("data:base64","data:image/jpeg;base64")}else{if(tmpSrc.lastIndexOf("data:,")!=-1){tmpSrc=tmpSrc.replace("data:,","data:image/jpeg;base64,")}}$.post(config.url,{img:tmpSrc,fileext:ext},function(data,status){if(status=="success"){if(typeof(success)=="function"){success(data,name,ext)}}else{if(typeof(error)=="function"){error(tmpSrc)}}})}else{if(tmpSrc.lastIndexOf("data:base64")!=-1){tmpSrc=tmpSrc.replace("data:base64","data:image/jpeg;base64")}else{if(tmpSrc.lastIndexOf("data:,")!=-1){tmpSrc=tmpSrc.replace("data:,","data:image/jpeg;base64,")}}if(typeof(success)=="function"){success(tmpSrc,name,ext)}else{var img='<img title="图片" src="'+tmpSrc+'"/>';$(imgBox).removeClass("none").html(img);if(_w!=""&&_h!=""){cssObj={"width":_w,"height":_h}}else{if(_w!=""&&_h==""){cssObj={"width":_w}}else{if(_h!=""&&_w==""){cssObj={"height":_h}}else{cssObj={"width":"auto","height":"auto"}}}}$(imgBox+" img").css(cssObj)}}}})(f);reader.readAsDataURL(f)};var getFileName=function(fileName){if(!fileName){return""}var _index=fileName.lastIndexOf(".");if(_index<1){return""}return fileName.substr(0,_index)};var getFileExt=function(fileName){if(!fileName){return""}var _index=fileName.lastIndexOf(".");if(_index<1){return""}return fileName.substr(_index+1)};var isAllowFile=function(fileName,allowType){var fileExt=getFileExt(fileName).toLowerCase();if(!allowType){allowType=["jpg","jpeg","png","gif","bmp"]}if($.inArray(fileExt,allowType)!=-1){return true}return false};var isAllowSize=function(fileSize,allowSize){if(config.allowSize>0&&fileSize>allowSize*1024){return false}return true}}})(jQuery);